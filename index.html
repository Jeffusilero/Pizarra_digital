<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizarra digital Guayaquil - Quito</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
        }
        
        .container {
            width: 70%;
            max-width: 1200px;
        }
        
        h2 {
            color: #333;
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
        }
        
        th {
            background-color: #b3b1b1;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            width: 22px;
            height: 22px;
        }
        
        .btn-action {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .btn-red {
            background-color: #ff4444;
        }
        
        .btn-yellow {
            background-color: #eeff00;
        }
        
        .btn-orange {
            background-color: #ff8800;
        }
        
        .btn-green {
            background-color: #00C851;
        }
        
        .btn-blue {
            background-color: #4285f4;
            color: white;
        }
        
        .btn-light-blue {
            background-color: #5bc0de;
            color: white;
        }
        
        .btn-gray {
            background-color: #aaaaaa;
            color: white;
        }
        
        .add-section {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .add-btn, .import-btn, .assign-btn {
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .add-btn {
            background-color: #4285f4;
        }
        
        .assign-btn {
            background-color: #5bc0de;
        }
        
        .import-btn {
            background-color: #34a853;
        }
        
        .retener {
            background-color: #ff4444;
            color: white;
        }
        
        .retener-amarillo {
            background-color: #eeff00;
            color: black;
        }

        .retener-naranja {
            background-color: #ff8800;
            color: black;
        }
        
        .liberar {
            background-color: #00C851;
            color: white;
        }
        
        .file-input {
            display: none;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 15px;
            border: 1px solid #888;
            width: 60%;
            max-width: 300px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .modal-form input, .modal-form select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .modal-btn {
            background-color: #4285f4;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.9em;
        }
        
        .search-container {
            width: 100%;
            margin: 0 auto 15px auto;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .search-input {
            width: 25%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }
        
        .item-counter {
            font-weight: bold;
        }
        
        .color-buttons {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            justify-content: center;
        }
        
        .color-btn {
            padding: 12px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        /* Estilos para los botones de acción */
        .action-menu {
            display: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 10;
        }

        .action-menu .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-trigger {
            position: relative;
            display: inline-block;
        }
        
        /* Estilos para el estado de carga */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Estado de carga -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <p>Cargando datos...</p>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container">
        <h2>Pizarra digital Guayaquil - Quito</h2>

        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Buscar Guía" oninput="filterTable()">
            <span class="item-counter" id="itemCounter">0 items</span>
        </div>

        <div class="add-section">
            <button class="add-btn" onclick="openAddModal()">Nuevo Item</button>
            <button class="assign-btn" onclick="openAssignModal()">Asignar Manifiesto</button>
            <button class="import-btn" onclick="document.getElementById('fileInput').click()">Importar Excel</button>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls" onchange="handleFileImport(this)">
        </div>
        
        <table id="pizarra-table">
            <thead>
                <tr>
                    <th>GUIA</th>
                    <th>MANIFIESTO</th>
                    <th>DESCRIPCION</th>
                    <th>CIUDAD</th>
                    <th>ACCION</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los datos se cargarán aquí -->
            </tbody>
        </table>
    </div>

    <!-- Modal para agregar -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2>Agregar Nuevo Item</h2>
            <div class="modal-form">
                <input type="text" id="add-guia" placeholder="GUIA" required>
                <input type="text" id="add-manifiesto" placeholder="MANIFIESTO" required>
                <select id="add-descripcion" required>
                    <option value="">Seleccione descripción</option>
                    <option value="RETENER">RETENER</option>
                    <option value="EDITAR DESTINATARIO">EDITAR DESTINATARIO</option>
                    <option value="EDITAR DIRECCION">EDITAR DIRECCION</option>
                    <option value="EDITAR CIUDAD">EDITAR CIUDAD</option>
                    <option value="EDITAR TELEFONO">EDITAR TELEFONO</option>
                    <option value="EDITAR TODO">EDITAR TODO</option>
                    <option value="LIBERAR">LIBERAR</option>
                </select>
                <button class="modal-btn" onclick="addItem()">Agregar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para asignar manifiesto -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAssignModal()">&times;</span>
            <h2>Asignar Manifiesto</h2>
            <div class="modal-form">
                <input type="text" id="assign-manifiesto" placeholder="Número de Manifiesto" required>
                <select id="assign-ciudad" required>
                    <option value="">Seleccione ciudad</option>
                    <option value="GYE">GYE</option>
                    <option value="QUT">QUT</option>
                </select>
                <button class="modal-btn" onclick="assignManifest()">Asignar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para editar -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Editar Item</h2>
            <div class="modal-form">
                <input type="text" id="edit-guia" placeholder="GUIA">
                <input type="text" id="edit-manifiesto" placeholder="MANIFIESTO">
                <select id="edit-descripcion">
                    <option value="RETENER">RETENER</option>
                    <option value="EDITAR DESTINATARIO">EDITAR DESTINATARIO</option>
                    <option value="EDITAR DIRECCION">EDITAR DIRECCION</option>
                    <option value="EDITAR CIUDAD">EDITAR CIUDAD</option>
                    <option value="EDITAR TELEFONO">EDITAR TELEFONO</option>
                    <option value="EDITAR TODO">EDITAR TODO</option>
                    <option value="LIBERAR">LIBERAR</option>
                </select>
                <button class="modal-btn" onclick="saveChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuración de GitHub
        const DEFAULT_CONFIG = {
            owner: 'Jeffusilero',
            repo: 'Pizarra_digital',
            branch: 'main',
            dataFile: 'data.json',
        };

        let githubConfig = {...DEFAULT_CONFIG};
        let database = [];
        let manifestAssignments = {};
        let currentEditingRow = null;
        
        // Mostrar estado de carga
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        // Ocultar estado de carga
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Al cargar la página
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            try {
                // Cargar configuración guardada o usar la predeterminada
                const savedConfig = localStorage.getItem('githubConfig');
                if (savedConfig) {
                    githubConfig = JSON.parse(savedConfig);
                } else {
                    localStorage.setItem('githubConfig', JSON.stringify(DEFAULT_CONFIG));
                }
                
                await loadFromGitHub();
                loadData();
            } catch (error) {
                console.error('Error al cargar datos:', error);
                alert('Error al cargar datos. Verifica la conexión o configuración.');
            } finally {
                hideLoading();
            }
        });
    // Ejemplo de código para manejar errores de carga
    fetch('datos.json')
      .then(response => {
        if (!response.ok) throw new Error('Error en la red');
        return response.json();
      })
      .catch(error => {
        console.error('Error:', error);
        // Mostrar mensaje alternativo o reintentar
      });
        // Función para abrir modal de agregar
        function openAddModal() {
            document.getElementById('addModal').style.display = 'block';
        }
        
        // Función para cerrar modal de agregar
        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }
        
        // Función para abrir modal de asignación
        function openAssignModal() {
            document.getElementById('assignModal').style.display = 'block';
        }
        
        // Función para cerrar modal de asignación
        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
        }
        
        // Función para cerrar modal de edición
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Función para cargar datos desde GitHub
        async function loadFromGitHub() {
            try {
                // Cargar datos principales (guías)
                const dataResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.dataFile}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (dataResponse.ok) {
                    const dataContent = await dataResponse.json();
                    const decodedData = atob(dataContent.content);
                    database = JSON.parse(decodedData);
                } else if (dataResponse.status === 404) {
                    database = [];
                } else {
                    throw new Error('Error al cargar datos');
                }

                // Cargar asignaciones de manifiestos
                const manifestResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.manifestFile}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (manifestResponse.ok) {
                    const manifestContent = await manifestResponse.json();
                    const decodedManifests = atob(manifestContent.content);
                    manifestAssignments = JSON.parse(decodedManifests);
                } else if (manifestResponse.status === 404) {
                    manifestAssignments = {};
                } else {
                    throw new Error('Error al cargar asignaciones de manifiestos');
                }
            } catch (error) {
                console.error('Error al cargar desde GitHub:', error);
                throw error;
            }
        }
        
        fetch('https://jeffusilero.github.io/data.json')
  .then(response => console.log('Conexión exitosa:', response))
  .catch(error => console.error('Error de conexión:', error));

        // Función para guardar datos en GitHub
        async function saveToGitHub() {
            showLoading();
            try {
                // Obtener SHAs de los archivos existentes
                let dataSha = '';
                let manifestSha = '';
                
                const dataCheck = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.dataFile}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (dataCheck.ok) {
                    const dataContent = await dataCheck.json();
                    dataSha = dataContent.sha;
                }
                
                const manifestCheck = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.manifestFile}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (manifestCheck.ok) {
                    const manifestContent = await manifestCheck.json();
                    manifestSha = manifestContent.sha;
                }
                
                // Guardar datos principales (guías)
                const dataContent = btoa(JSON.stringify(database, null, 2));
                await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.dataFile}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Actualización de datos de pizarra',
                        content: dataContent,
                        sha: dataSha || undefined,
                        branch: githubConfig.branch
                    })
                });
                
                // Guardar asignaciones de manifiestos
                const manifestContent = btoa(JSON.stringify(manifestAssignments, null, 2));
                await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.manifestFile}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Actualización de asignaciones de manifiestos',
                        content: manifestContent,
                        sha: manifestSha || undefined,
                        branch: githubConfig.branch
                    })
                });
            } catch (error) {
                console.error('Error al guardar en GitHub:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Función para cargar datos en la tabla
        function loadData() {
            const tableBody = document.getElementById('pizarra-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            database.forEach(item => {
                const newRow = tableBody.insertRow();
                let descClass = '';
                
                if(item.descripcion === "RETENER") {
                    if(item.ciudad === "GYE") {
                        descClass = 'retener-amarillo';
                    } else if(item.ciudad === "QUT") {
                        descClass = 'retener-naranja';
                    } else {
                        descClass = 'retener';
                    }
                } else if(item.descripcion === "LIBERAR") {
                    descClass = 'liberar';
                }
                
                // Contenedor de acciones
                const actionContainer = document.createElement('td');
                
                if(item.descripcion === "RETENER") {
                    actionContainer.innerHTML = `
                        <div class="action-buttons">
                            <div class="action-trigger">
                                <button class="btn-action btn-blue" onclick="toggleActionMenu(this)">Acción</button>
                                <div class="action-menu">
                                    <div class="action-buttons">
                                        <button class="btn-action btn-light-blue" onclick="assignFromRow(this)">Asignar</button>
                                        <button class="btn-action btn-green" onclick="liberarFromRow(this)">Liberar</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                        </div>
                    `;
                } else {
                    actionContainer.innerHTML = `
                        <div class="action-buttons">
                            <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                        </div>
                    `;
                }
                
                newRow.innerHTML = `
                    <td>${item.guia}</td>
                    <td>${item.manifiesto}</td>
                    <td class="${descClass}">${item.descripcion}</td>
                    <td>${item.ciudad || ''}</td>
                `;
                
                newRow.appendChild(actionContainer);
            });
            
            updateCounter();
        }
        function processExcelData(data) {
          return data.map(row => {
            if (row.master && !row.ciudad) {
              row.ciudad = masterCity; // Usa la ciudad previamente asignada
            }
            return row;
          });
        }
        // Función para alternar menú de acción
        function toggleActionMenu(button) {
            const menu = button.nextElementSibling;
            const allMenus = document.querySelectorAll('.action-menu');
            
            // Cerrar todos los otros menús
            allMenus.forEach(m => {
                if(m !== menu) m.style.display = 'none';
            });
            
            // Alternar el menú actual
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        // Cerrar menús al hacer clic fuera
        document.addEventListener('click', function(e) {
            if(!e.target.closest('.action-trigger')) {
                document.querySelectorAll('.action-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        // Función para asignar manifiesto desde fila
        async function assignFromRow(button) {
            const row = button.closest('tr');
            const manifiesto = row.cells[1].textContent;
            
            if (manifestAssignments[manifiesto]) {
                const ciudad = manifestAssignments[manifiesto];
                
                // Actualizar TODAS las guías con este manifiesto
                database.forEach(item => {
                    if (item.manifiesto === manifiesto && item.descripcion === "RETENER") {
                        item.ciudad = ciudad;
                    }
                });
                
                // Guardar cambios
                await saveToGitHub();
                loadData();
            } else {
                alert('Este manifiesto no tiene una ciudad asignada. Use el botón "Asignar Manifiesto" primero.');
            }
            
            toggleActionMenu(button.closest('.action-trigger').querySelector('button'));
        }

        // Función para asignar un manifiesto (desde modal)
        async function assignManifest() {
            const manifiesto = document.getElementById('assign-manifiesto').value;
            const ciudad = document.getElementById('assign-ciudad').value;
            
            if (!manifiesto || !ciudad) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            // 1. Guardar la asignación
            manifestAssignments[manifiesto] = ciudad;
            
            // 2. Actualizar TODAS las guías con este manifiesto
            database.forEach(item => {
                if (item.manifiesto === manifiesto && item.descripcion === "RETENER") {
                    item.ciudad = ciudad;
                }
            });
            
            // 3. Guardar cambios
            try {
                await saveToGitHub();
                loadData();
                
                document.getElementById('assign-manifiesto').value = '';
                document.getElementById('assign-ciudad').value = '';
                closeAssignModal();
            } catch (error) {
                alert('Error al guardar los cambios');
                console.error(error);
            }
        }

        // Función para agregar nueva guía
        async function addItem() {
            const guia = document.getElementById('add-guia').value;
            const manifiesto = document.getElementById('add-manifiesto').value;
            const descripcion = document.getElementById('add-descripcion').value;
            
            if (!guia || !manifiesto || !descripcion) {
                alert('Por favor complete los campos obligatorios');
                return;
            }
            
            // Verificar si la guía ya existe
            if (database.some(item => item.guia === guia)) {
                alert('Esta guía ya existe en el sistema');
                return;
            }
            
            // Asignar ciudad automáticamente si el manifiesto tiene una
            let ciudad = '';
            if (descripcion === "RETENER" && manifestAssignments[manifiesto]) {
                ciudad = manifestAssignments[manifiesto];
            }
            
            // Agregar nueva guía
            database.push({
                guia: guia,
                manifiesto: manifiesto,
                descripcion: descripcion,
                ciudad: ciudad
            });
            
            // Guardar cambios
            try {
                await saveToGitHub();
                loadData();
                
                document.getElementById('add-guia').value = '';
                document.getElementById('add-manifiesto').value = '';
                document.getElementById('add-descripcion').value = '';
                closeAddModal();
            } catch (error) {
                alert('Error al guardar el nuevo item');
                console.error(error);
            }
        }

        // Función para eliminar item
        async function deleteItem(button) {
            if (!confirm('¿Está seguro que desea eliminar este item?')) return;
            
            const row = button.closest('tr');
            const guia = row.cells[0].textContent;
            
            // Eliminar de la base de datos
            database = database.filter(item => item.guia !== guia);
            
            // Guardar en GitHub
            try {
                await saveToGitHub();
                row.remove();
                updateCounter();
            } catch (error) {
                alert('Error al eliminar el item');
                console.error(error);
            }
        }

        // Función para editar item
        function editItem(button) {
            const row = button.closest('tr');
            currentEditingRow = row;
            
            const guia = row.cells[0].textContent;
            const manifiesto = row.cells[1].textContent;
            const descripcion = row.cells[2].textContent;
            
            document.getElementById('edit-guia').value = guia;
            document.getElementById('edit-manifiesto').value = manifiesto;
            document.getElementById('edit-descripcion').value = descripcion;
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Función para guardar cambios
        async function saveChanges() {
            const guia = document.getElementById('edit-guia').value;
            const manifiesto = document.getElementById('edit-manifiesto').value;
            const descripcion = document.getElementById('edit-descripcion').value;
            
            if (!guia) {
                alert('Por favor complete la guía');
                return;
            }
            
            currentEditingRow.cells[0].textContent = guia;
            currentEditingRow.cells[1].textContent = manifiesto;
            currentEditingRow.cells[2].textContent = descripcion;
            
            if (descripcion === "RETENER") {
                // Mantener la ciudad si ya estaba asignada
                const ciudad = currentEditingRow.cells[3].textContent;
                if(ciudad === "GYE") {
                    currentEditingRow.cells[2].className = 'retener-amarillo';
                } else if(ciudad === "QUT") {
                    currentEditingRow.cells[2].className = 'retener-naranja';
                } else {
                    currentEditingRow.cells[2].className = 'retener';
                }
                
                // Actualizar botones de acción para RETENER
                const actionCell = currentEditingRow.cells[4];
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <div class="action-trigger">
                            <button class="btn-action btn-blue" onclick="toggleActionMenu(this)">Acción</button>
                            <div class="action-menu">
                                <div class="action-buttons">
                                    <button class="btn-action btn-light-blue" onclick="assignFromRow(this)">Asignar</button>
                                    <button class="btn-action btn-green" onclick="liberarFromRow(this)">Liberar</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                    </div>
                `;
            } else if (descripcion === "LIBERAR") {
                currentEditingRow.cells[2].className = 'liberar';
                currentEditingRow.cells[3].textContent = '';
                
                // Actualizar botones de acción - solo Eliminar para LIBERAR
                const actionCell = currentEditingRow.cells[4];
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                    </div>
                `;
            } else {
                currentEditingRow.cells[2].className = '';
                currentEditingRow.cells[3].textContent = '';
                
                // Para otros estados: Mostrar solo Eliminar
                const actionCell = currentEditingRow.cells[4];
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                    </div>
                `;
            }
            
            // Actualizar en la base de datos
            const index = database.findIndex(item => item.guia === currentEditingRow.cells[0].textContent);
            if(index !== -1) {
                database[index] = {
                    guia: guia,
                    manifiesto: manifiesto,
                    descripcion: descripcion,
                    ciudad: currentEditingRow.cells[3].textContent || ''
                };
                await saveToGitHub();
            }
            
            closeEditModal();
        }

        // Función para liberar desde fila
        async function liberarFromRow(button) {
            const row = button.closest('tr');
            const guia = row.cells[0].textContent;
            
            // Actualizar en la base de datos
            const index = database.findIndex(item => item.guia === guia);
            if(index !== -1) {
                database[index].descripcion = "LIBERAR";
                database[index].ciudad = '';
                
                try {
                    await saveToGitHub();
                    
                    row.cells[2].textContent = "LIBERAR";
                    row.cells[2].className = 'liberar';
                    row.cells[3].textContent = '';
                    
                    // Actualizar botones de acción
                    const actionCell = row.cells[4];
                    actionCell.innerHTML = `
                        <div class="action-buttons">
                            <button class="btn-action btn-gray" onclick="deleteItem(this)">Eliminar</button>
                        </div>
                    `;
                } catch (error) {
                    alert('Error al liberar el item');
                    console.error(error);
                }
            }
            
            toggleActionMenu(button.closest('.action-trigger').querySelector('button'));
        }

        // Función para importar desde Excel
        async function handleFileImport(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Obtener la primera hoja
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Convertir a JSON
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                // Procesar los datos (omitir la primera fila de encabezados)
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];
                    if (rowData.length < 3) continue;
                    
                    const guia = rowData[0]?.toString() || '';
                    const manifiesto = rowData[1]?.toString() || '';
                    const descripcion = rowData[2]?.toString() || '';
                    const ciudad = rowData[3]?.toString() || '';
                    
                    // Verificar si la guía ya existe
                    const existingIndex = database.findIndex(item => item.guia === guia);
                    
                    if (existingIndex === -1) {
                        // Si no existe, agregar nueva
                        database.push({
                            guia: guia,
                            manifiesto: manifiesto,
                            descripcion: descripcion,
                            ciudad: ciudad
                        });
                        
                        // Si hay ciudad especificada, asignar al manifiesto
                        if (ciudad && (ciudad === "GYE" || ciudad === "QUT")) {
                            manifestAssignments[manifiesto] = ciudad;
                        }
                    } else {
                        // Si existe, actualizar
                        database[existingIndex] = {
                            guia: guia,
                            manifiesto: manifiesto,
                            descripcion: descripcion,
                            ciudad: ciudad
                        };
                    }
                }
                
                // Guardar en GitHub
                try {
                    await saveToGitHub();
                    loadData();
                } catch (error) {
                    alert('Error al guardar los datos importados');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Función para actualizar el contador
        function updateCounter() {
            const count = database.length;
            const counterElement = document.getElementById('itemCounter');
            counterElement.textContent = count === 1 ? '1 item' : `${count} items`;
        }

        // Función para filtrar la tabla
        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('pizarra-table');
            const tr = table.getElementsByTagName('tr');
            
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }       
            }
        }
        
        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const assignModal = document.getElementById('assignModal');
            const editModal = document.getElementById('editModal');
            
            if (event.target == addModal) {
                closeAddModal();
            }
            if (event.target == assignModal) {
                closeAssignModal();
            }
            if (event.target == editModal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>

